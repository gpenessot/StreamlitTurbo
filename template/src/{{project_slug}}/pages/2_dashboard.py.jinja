"""
Page Dashboard - Visualisations et analytics
D√©montre l'utilisation des composants r√©utilisables
"""

import streamlit as st
import pandas as pd
<<<<<<< HEAD
from {{ project_slug | replace('-', '_') }}.components.charts import (
    create_line_chart,
    create_pie_chart,
    create_bar_chart,
    create_multi_line_chart,
    generate_sample_data
)
=======
import plotly.express as px
import plotly.graph_objects as go
import numpy as np
>>>>>>> df322c8cc8dde79d0493035a28700d1de3c302f8
from {{ project_slug | replace('-', '_') }}.components.footer import render_footer

def main():
    """Dashboard avec graphiques interactifs utilisant les composants modulaires."""
    
    st.title(":material/insert_chart: Dashboard Analytics")
    st.markdown("*D√©monstration des composants graphiques r√©utilisables*")
    
    # ========================================
    # CHARGEMENT DES DONN√âES
    # ========================================
    # Utiliser la fonction de g√©n√©ration du composant charts.py
    @st.cache_data
<<<<<<< HEAD
    def load_data():
        return generate_sample_data(365)  # 1 an de donn√©es
=======
    def load_sample_data():
        dates = pd.date_range(start='2025-01-01', end='2025-12-31', freq='D')
        np.random.seed(42)
        
        data = pd.DataFrame({
            'date': dates,
            'ventes': np.random.normal(1000, 200, len(dates)).astype(int) + np.arange(len(dates)) * 2,
            'visitors': np.random.normal(500, 100, len(dates)).astype(int) + np.arange(len(dates)),
            'conversion_rate': np.random.normal(0.05, 0.01, len(dates)).round(3),
            'category': np.random.choice(['Electronique', 'Mode', 'Maison'], len(dates))
        })
        
        return data
>>>>>>> df322c8cc8dde79d0493035a28700d1de3c302f8
    
    df = load_data()
    
    # ========================================
    # SECTION FILTRES
    # ========================================
    st.subheader(":material/filter_alt: Filtres")
<<<<<<< HEAD
    
    col1, col2 = st.columns([2, 3])
    
=======

    col1, col2 = st.columns([2, 3])

>>>>>>> df322c8cc8dde79d0493035a28700d1de3c302f8
    with col1:
        start_date = st.date_input(
            "Date d√©but",
            value=df['date'].min().date(),
            min_value=df['date'].min().date(),
            max_value=df['date'].max().date()
        )

    with col2:
        end_date = st.date_input(
            "Date fin",
            value=df['date'].max().date(),
            min_value=df['date'].min().date(),
            max_value=df['date'].max().date()
        )
<<<<<<< HEAD
    
    st.write("**Cat√©gories**")
=======

    st.write("**Categories**")
>>>>>>> df322c8cc8dde79d0493035a28700d1de3c302f8
    categories = st.pills(
        "Categories",
        options=df['category'].unique().tolist(),
        default=df['category'].unique().tolist(),
        selection_mode="multi",
        label_visibility="collapsed"
    )
    
    # Appliquer les filtres
    filtered_df = df[
        (df['date'].dt.date >= start_date) &
        (df['date'].dt.date <= end_date) &
        (df['category'].isin(categories))
    ]
    
    # ========================================
    # KPIs RAPIDES
    # ========================================
    st.markdown("---")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        total_sales = filtered_df['sales'].sum()
        st.metric(
            "Ventes totales",
            f"‚Ç¨{total_sales:,.0f}".replace(',', ' '),
            delta=f"{filtered_df['sales'].pct_change().mean()*100:.1f}%"
        )
    
    with col2:
        total_visits = filtered_df['visits'].sum()
        st.metric(
            "Visiteurs",
            f"{total_visits:,.0f}".replace(',', ' '),
            delta=f"{filtered_df['visits'].pct_change().mean()*100:.1f}%"
        )
    
    with col3:
        avg_conversion = filtered_df['conversion_rate'].mean()
        st.metric(
            "Taux de conversion",
            f"{avg_conversion*100:.2f}%",
            delta=f"{(avg_conversion - 0.05)*100:.2f}%"
        )
    
    with col4:
        avg_basket = filtered_df['sales'].sum() / filtered_df['visits'].sum()
        st.metric(
            "Panier moyen",
            f"‚Ç¨{avg_basket:.2f}",
            delta="3.2%"
        )
    
    # ========================================
    # GRAPHIQUES LIGNE 1 - √âVOLUTION
    # ========================================
    st.markdown("---")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader(":material/show_chart: √âvolution des ventes")
        
        # ‚úÖ UTILISATION DU COMPOSANT R√âUTILISABLE
        fig_line = create_line_chart(
            filtered_df,
            x_col='date',
            y_col='sales',
            title="Ventes quotidiennes",
            color='#1ed760',  # Couleur personnalis√©e
            height=400
        )
<<<<<<< HEAD
        st.plotly_chart(fig_line, use_container_width=True)
=======
        fig_line.update_traces(line_color='#1ed760')
        st.plotly_chart(fig_line)
>>>>>>> df322c8cc8dde79d0493035a28700d1de3c302f8
    
    with col2:
        st.subheader(":material/trending_up: √âvolution des visiteurs")
        
        # ‚úÖ UTILISATION DU COMPOSANT R√âUTILISABLE
        fig_visits = create_line_chart(
            filtered_df,
            x_col='date',
            y_col='visits',
            title="Visiteurs quotidiens",
            color='#2d46b9',
            height=400
        )
<<<<<<< HEAD
        st.plotly_chart(fig_visits, use_container_width=True)
=======
        st.plotly_chart(fig_pie)
>>>>>>> df322c8cc8dde79d0493035a28700d1de3c302f8
    
    # ========================================
    # GRAPHIQUES LIGNE 2 - R√âPARTITION
    # ========================================
    st.markdown("---")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader(":material/pie_chart: R√©partition par cat√©gorie")
        
        # Agr√©ger les donn√©es par cat√©gorie
        category_sales = filtered_df.groupby('category')['sales'].sum().reset_index()
        
        # ‚úÖ UTILISATION DU COMPOSANT R√âUTILISABLE
        fig_pie = create_pie_chart(
            category_sales,
            names_col='category',
            values_col='sales',
            title="Ventes par cat√©gorie",
            height=400
        )
        st.plotly_chart(fig_pie, use_container_width=True)
    
    with col2:
        st.subheader(":material/bar_chart: Top 5 jours")
        
        # S√©lectionner les 5 meilleurs jours
        top_days = filtered_df.nlargest(5, 'sales')[['date', 'sales']].copy()
        top_days['date_str'] = top_days['date'].dt.strftime('%d/%m')
        
        # ‚úÖ UTILISATION DU COMPOSANT R√âUTILISABLE
        fig_bar = create_bar_chart(
            top_days,
            x_col='date_str',
            y_col='sales',
            title="Top 5 journ√©es de ventes",
            color='#ffc862',
            height=400
        )
        st.plotly_chart(fig_bar, use_container_width=True)
    
    # ========================================
    # GRAPHIQUE MULTI-LIGNES
    # ========================================
    st.markdown("---")
    st.subheader(":material/multiline_chart: Vue d'ensemble multi-m√©triques")
    
    # Pr√©parer les donn√©es pour le graphique multi-lignes
    # Normaliser les √©chelles pour comparaison visuelle
    multi_df = filtered_df[['date', 'sales', 'visits']].copy()
    multi_df['sales_normalized'] = (multi_df['sales'] / multi_df['sales'].max()) * 100
    multi_df['visits_normalized'] = (multi_df['visits'] / multi_df['visits'].max()) * 100
    
    # ‚úÖ UTILISATION DU COMPOSANT R√âUTILISABLE
    fig_multi = create_multi_line_chart(
        multi_df,
        x_col='date',
        y_cols=['sales_normalized', 'visits_normalized'],
        title="√âvolution compar√©e (normalis√©e √† 100)",
        height=400
    )
    st.plotly_chart(fig_multi, use_container_width=True)
    
    st.caption("*Donn√©es normalis√©es pour comparaison visuelle*")
    
    # ========================================
    # TABLEAU DE DONN√âES
    # ========================================
    st.markdown("---")
    st.subheader(":material/table: Donn√©es d√©taill√©es")
    
    # Options d'affichage
    col1, col2 = st.columns([3, 1])
    
    with col2:
        show_all = st.checkbox("Afficher tout", value=False)
    
    # Afficher le tableau
    display_df = filtered_df if show_all else filtered_df.head(100)
    
    st.dataframe(
<<<<<<< HEAD
        display_df[['date', 'sales', 'visits', 'conversion_rate', 'category']],
        width="stretch",
        hide_index=True,
        column_config={
            "date": st.column_config.DateColumn("Date", format="DD/MM/YYYY"),
            "sales": st.column_config.NumberColumn("Ventes", format="‚Ç¨%.0f"),
            "visits": st.column_config.NumberColumn("Visites", format="%d"),
            "conversion_rate": st.column_config.NumberColumn(
                "Taux conversion",
                format="%.2f%%",
                help="Taux de conversion visiteurs ‚Üí ventes"
            ),
            "category": st.column_config.TextColumn("Cat√©gorie")
        }
=======
    )
    
    if not show_all:
        st.caption(f"*Affichage des 100 premi√®res lignes sur {len(filtered_df)} total*")
    
    # ========================================
    # SECTION EXPORT
    # ========================================
    st.markdown("---")
    st.subheader(":material/download: Export des donn√©es")
    
    col1, col2, col3 = st.columns([1, 1, 2])
    
    with col1:
        # Export CSV
        csv = filtered_df.to_csv(index=False)
        st.download_button(
            label=":material/description: T√©l√©charger CSV",
            data=csv,
            file_name="dashboard_data.csv",
            mime="text/csv"
        )
    
    with col2:
        # Export des statistiques
        stats = filtered_df.describe().to_csv()
        st.download_button(
            label=":material/analytics: T√©l√©charger Stats",
            data=stats,
            file_name="dashboard_stats.csv",
            mime="text/csv"
        )
    
    # ========================================
    # INFORMATIONS COMPL√âMENTAIRES
    # ========================================
    with st.expander(":material/info: √Ä propos de ce dashboard"):
        st.markdown("""
        ### üìä Composants utilis√©s
        
        Ce dashboard d√©montre l'utilisation des composants r√©utilisables d√©finis dans `charts.py` :
        
        - ‚úÖ `create_line_chart()` - Graphiques lin√©aires
        - ‚úÖ `create_pie_chart()` - Graphiques circulaires  
        - ‚úÖ `create_bar_chart()` - Graphiques en barres
        - ‚úÖ `create_multi_line_chart()` - Graphiques multi-lignes
        - ‚úÖ `generate_sample_data()` - G√©n√©ration de donn√©es
        
        ### üéØ Avantages de l'approche modulaire
        
        1. **R√©utilisabilit√©** : M√™me code pour tous les graphiques
        2. **Maintenance** : Un seul endroit √† modifier pour changer le style
        3. **Coh√©rence** : Apparence uniforme garantie
        4. **Productivit√©** : Cr√©ation rapide de nouveaux dashboards
        
        ### üîß Personnalisation
        
        Tous les param√®tres (couleurs, hauteur, titres) sont personnalisables 
        via les arguments des fonctions.
        """)
    
    # Footer en fin de page
    render_footer()

if __name__ == "__main__":
    main()